<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w, d, s, l, i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-WG2KK6D');</script>
    <!-- End Google Tag Manager -->

    {% load static_url %}

    {% block local_css %}
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <meta name="login" content="send_initial_mail_confirm_login">
        <link rel="stylesheet" href={% static_url "user/css/trainer/pters.trainer.register.css" %}>
        <style type="text/css">
            button:focus{
                outline: 0;
            }
            .disabled_button{
                opacity: 0.5 !important;
                cursor: default !important;
            }
            #email_input_form{
                background-color: transparent;
                color: #ffffff;
                border: 0;
            }
            .input_write_mode{
                background-color: #ffffff !important;
                color: #282828 !important;
                border: 1px solid #fe4e65 !important;
            }
            .write_mode_ing{
                border-color: #fe4e65 !important;
                color: #fe4e65 !important;
                background-color: #282828 !important;
            }
            #submit_input{
                overflow-y: hidden;
                margin: 0;
                transition: 0.3s;
                -webkit-transition: 0.3s;
            }
            #submit_complete{
                height: 0;
                transition: 0.5s;
                -webkit-transition: 0.5s;
                overflow-y: hidden;
                margin: 0;
                padding-left: 20px;
                font-size: 14px;
            }
            .submit_email_reconfirm, .submit_go_home, .submit_email_change{
                position: relative !important;
                margin: 0 auto !important;
                margin-top: 10px !important;
                left: unset !important;
                transform: unset !important;
            }
            .submit_go_home{
                color: #fe4e65 !important;
                position: relative !important;
                margin: 0 auto !important;
                margin-top: 15px !important;
                left: unset !important;
                transform: unset !important;
            }
            #ajaxloadingPC{
                position: fixed;
                display: none;
                height: 60px;
                left: 50%;
                transform:translate(-50%,-50%);
                z-index: 202;
            }

            #id_email{
                width: 220px;
                height: 25px;
                font-size: 15px;
            }

            .pw_confirm{
                position: absolute;
                margin: 0;
                display: inline;
                left: 0;
                margin-left: 35px;
            }


            #inputError_info{
                display: none;
            }
            .email_confirm{
                margin-top: 0;
                padding-left: 50px;
            }

        </style>

    {% endblock %}

</head>
{% load i18n %}

<body>

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WG2KK6D"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
{% block content %}
    <div class="outerbox_horizontal" data-view="init" style="width:auto;">
        <div id="inputError_info">
            <div id="errorMsg_info" class="inputErrorInner">
                <p style="line-height: 35px;vertical-align: middle;margin:0;"></p>
            </div>
        </div>
        <div class="explainbox _type_trainee" style="width: 315px;">
            <img src="/static/user/res/login/icon-reg-user.png">
            <p><span class="font-pink">이메일 인증</span></p>
            <p>PTERS를 처음 이용하시는 분께서는<br>이메일 인증 후 서비스를 이용하실 수 있습니다.</p>
            <div class="explaintype" id="submit_input">
                <form method="post" action="../../templates/registration" style="text-align: center!important;padding-left: 20px;">
                    {% csrf_token %}
                    <input type="hidden" name="prev_email" value="" id="prev_email">
                    <input type="hidden" name="member_id" value="{{ request.session.user_id }}">
                    <input type="hidden" name="username" value="{{ request.session.username }}">
                    <input type="hidden" name="member_type" value="re">
                    <input type="hidden" name="email" value="" id="form_email">

                    <!--<input type="submit" value="{% trans 'Submit' %}" />-->
                    <p style="margin-bottom:0">Email : <input type="text" name="" autocomplete="off" id="email_input_form" disabled> </p>
                    <p class="email_confirm"></p>
                    <p>인증 메일은 {{ activation_days }}일간 유효합니다.</p>
                </form>
                <button class="submit_email_reconfirm" >재인증 메일 보내기</button>
                <button id="btn_change_email" class="submit_email_change">E-mail 변경</button>
                <button class="submit_go_home" onclick="goHome()" style="margin-bottom:15px !important">뒤로</button>
                <img src="/static/user/res/ajax/loading.gif" alt="" class="ajaxloadingPC" id="ajaxloadingPC">
            </div>
            <div class="explaintype" id="submit_complete">
                <p>입력하신 메일주소로</p>
                <p>인증메일이 발송 되었습니다.</p>
                <p>메일을 확인하여 계정을 활성화 해주세요.</p>
                <button class="submit_go_home" onclick="goHome()">로그인 페이지</button>
            </div>
        </div>
    </div>

{% endblock %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>
    $(window).keydown(function(event){
        if(event.which== 13) {
          event.preventDefault();
          return false;
        }
    });

    $('#email_input_form, #prev_email').val("{{ user_email }}");
    $('button.submit_email_reconfirm').click(function(){
        //if($('.pw_confirm').attr('data-check') == 1){
        if(!$(this).hasClass('disabled_button')){
            $("#form_email").val($('#email_input_form').val());
            if($("#form_email").val() != $('#prev_email').val()){
                console.log("not")
                $form = $('#submit_input form');
                $.ajax({
                    url:'/login/change_resend_email_authentication/',
                    type:'POST',
                    data: $form.serialize(),
                    dataType : 'html',
                    async: false,

                    beforeSend:function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                        beforeSend();
                    },

                    //보내기후 팝업창 닫기
                    complete:function(){
                        completeSend();
                    },

                    //통신성공시 처리
                    success:function(data){
                        $('#submit_complete').css('height', '200px');
                        $('#submit_input').css('height', '0px');
                    },

                    //통신 실패시 처리
                    error:function(){
                        alert("서버 통신 에러가 발생하였습니다. 잠시후 다시 시도해주세요");
                    }
                });
                //}else{
                //  alert('비밀번호를 다시 확인해주세요')
                //}
            }else if($("#form_email").val() == $('#prev_email').val()){
                console.log("prev")
                $form = $('#submit_input form');
                $.ajax({
                    url:'/login/resend_email_authentication/',
                    type:'POST',
                    data: $form.serialize(),
                    dataType : 'html',
                    async: false,

                    beforeSend:function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                        beforeSend();
                    },

                    //보내기후 팝업창 닫기
                    complete:function(){
                        completeSend();
                    },

                    //통신성공시 처리
                    success:function(data){
                        $('#submit_complete').css('height', '200px');
                        $('#submit_input').css('height', '0px');
                    },

                    //통신 실패시 처리
                    error:function(){
                        alert("서버 통신 에러가 발생하였습니다. 잠시후 다시 시도해주세요");
                    }
                });
                //}else{
                //  alert('비밀번호를 다시 확인해주세요')
                //}
            }
            
        }
    });

    $('#btn_change_email').click(function(e){
        e.preventDefault();
        if($("#email_input_form").attr('disabled') == "disabled"){
            $('#email_input_form').attr('disabled', false).addClass('input_write_mode');
            $('#btn_change_email').addClass('write_mode_ing').text("E-mail 입력 완료");
            $('button.submit_email_reconfirm').addClass('disabled_button');
        }else{
            $('#email_input_form').attr('disabled', true).removeClass('input_write_mode');
            $('#btn_change_email').removeClass('write_mode_ing').text("E-mail 변경");
            $('button.submit_email_reconfirm').removeClass('disabled_button');
        }
    });

    $('#email_input_form').keyup(function(){
        check_email($(this).val());
    });

    function check_email(newemail){
        $.ajax({
            url:'/login/check_member_email/',
            type:'GET',
            data:{"email" : newemail },
            dataType : 'html',
            async: false,

            beforeSend:function(){
            },

            //통신성공시 처리
            success:function(data){
                var jsondata = JSON.parse(data);
                var id_check_message = jsondata.id_check_result;
                if(id_check_message[0].length>0){
                    var error_msg = id_check_message[0];
                    $('.email_confirm').text(error_msg).css({'display':'block', 'color':'#fe4e65'});
                    email_change_varification = false;
                }else{
                    $('.email_confirm').text('사용 가능').css({'display':'block', 'color':'green'});
                    email_change_varification = true;
                }
            },

            //보내기후 팝업창 닫기
            complete:function(){

            },

            //통신 실패시 처리
            error:function(){
                alert("에러: 서버 통신 실패");
            }
        });
    }


    function beforeSend(){
        $('#ajaxloadingPC').css('display', 'block');
        $('#submit_input button').css('visibility', 'hidden');
    }

    function completeSend(){
        $('#ajaxloadingPC').css('display', 'none');
        $('#submit_input button').css('visibility', 'visible');
    }

    function goHome(){
        location.href="{% url 'login:logout' %}";
    }

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

</script>
</body>
</html>