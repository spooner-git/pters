{% extends "trainer_base.html" %}
{% load static_url %}

{% block local_css %}
        <link rel="stylesheet" href={% static_url "user/css/trainee/pters.trainee.select.teacher.css" %}>
        <style type="text/css">
          body{
            background: #171717;
          }

          #myClassCreate{
            display: block;
            background: #f4f4f4;
            border:3px solid #fe4e65;
            border-radius: 9px;
            padding: 20px;
          }
          #myClassSetting{
            display: none;
            background: #f4f4f4;
            border:3px solid #fe4e65;
            border-radius: 9px;
            padding: 20px;
          }
          .classSettingBox{
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
          }
            .detailSelectBox{
              border:1px solid #cccccc;
              padding: 5px;
              margin-top: 10px;
              margin-bottom: 20px;
            }
            .detailSelectBox label{
              display: block;
              margin-top: 20px;
            }
          .memberConnectSettingBox{
            display: none;
            transition: 1s;
          }

          .dropdown{
            display: inline-block;
          }
            .dropdown button{
              min-width: 80px;
              height: 35px;
            }
            .dropdown ul{
              max-height: 140px;
              overflow-y: auto;
            }
            .dropdown li{
              cursor: pointer;
            }
            #dropdown_subject_1, #dropdown_subject_2{
              display: none;
            }

          button:focus{
            outline: unset;
          }
          .selected{
            background: #fe4e65;
            color: #ffffff;
            border-color:#fe4e65;
          }

          .fixfooter{
            z-index: -1;
          }

        </style>
{% endblock %}

{% block content %}

<form action="{% url 'trainer:add_class_info' %}" id="add-class-info-form" method="post">
    {% csrf_token %}
  <input type="hidden" name="center_id" id="center_id" value=""> <!--강좌 센터 -->
  <input type="hidden" name="subject_cd" id="subject_cd" value=""> <!--강좌 코드-->
  <input type="hidden" name="start_date" id="start_date" value=""> <!--강좌 시작 일자-->
  <input type="hidden" name="end_date" id="end_date" value=""> <!--강좌 종료 일자-->
  <input type="hidden" name="class_hour" id="class_hour" value=1.0> <!--강좌 진행 시간-->
  <input type="hidden" name="start_hour_unit" id="start_hour_unit" value="1.0"> <!--강좌 시작 시간(1: 정시, 0.5: 30분단위-->
  <input type="hidden" name="class_member_num" id="class_member_num" value="1"> <!--강좌 수업별 최대 허용 인원-->
</form>

<form action="{% url 'trainer:update_setting_reserve' %}" id="update-setting-reserve-form" method="post">
    {% csrf_token %}
  <input type="hidden" name="setting_trainer_work_time_available" id="id_setting_trainer_work_time" value=""> <!--min 00:00 max 23:59  업무 시간 설정 -->
  <input type="hidden" name="setting_member_reserve_time_available" id="id_setting_member_available_time" value=""> <!--min 00:00 max 23:59   회원 예약 허용 시간대-->
  <input type="hidden" name="setting_member_reserve_time_prohibition"   id="id_setting_member_reserve_time_prohibition" value=""> <!--시간 숫자-->
  <input type="hidden" name="setting_member_reserve_prohibition"   id="id_setting_member_reserve_prohibition" value=""> <!--예약금지 활성 1, 비활성 0-->
  <input type="hidden" name="next_page" value = '{% url 'trainer:trainer_error_info' %}'>
</form>

<div id="myClassCreate" class="classSettingBox">
    <label>1. 나의 클래스 만들기</label>
    <div>
        <p>나의 클래스를 추가합니다. <br>
          (예: PT, 요가, 필라테스, 발레, 미술 등)
        </p>
        <p>클래스는 설정에서 언제든지 추가가 할수 있습니다.</p>
    </div>
    <div>
        <label>만들고 하는 클래스를 입력해주세요.</label>
    </div>

    {% if center_list %}
        <div class="dropdown">
            <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">선택<span class="caret"></span></button>
            <ul id="center_list" class="dropdown-menu">
                  <li><a data-time="">선택 안함</a></li>
                {% for center_info in center_list %}
                  <li><a data-time="{{ center_info.center_id }}">{{ center_info.center.center_name }}</a></li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}


    <div class="dropdown" id="dropdown_subject_{{ forloop.counter }}">
        <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">선택<span class="caret"></span></button>
        <ul id="class_type" class="dropdown-menu">
            {% for class_type_cd_info in class_type_cd_data %}
              <li><a data-time="{{ class_type_cd_info.common_cd }}">{{ class_type_cd_info.common_cd_nm }}</a></li>
            {% endfor %}
        </ul>
    </div>

    {% for class_type_cd_info in class_type_cd_data %}
        <div class="dropdown" id="dropdown_subject_{{ forloop.counter }}">
            <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">선택<span class="caret"></span></button>
            <ul id="subject_type_{{ forloop.counter }}" class="dropdown-menu" display="none">
                {% for subject_type in class_type_cd_info.subject_type_cd %}
                  <li><a data-time="{{ subject_type.common_cd }}">{{ subject_type.common_cd_nm }}</a></li>
                {% endfor %}
            </ul>
        </div>
    {% endfor %}
    <button onclick="goNext('0')">다음</button>
    <button onclick="goNext('home')">취소</button>
</div>

<div id="myClassSetting" class="classSettingBox">
    <label>2. 나의 클래스 설정</label>
    <div>
        <p>클래스 정보를 설정합니다. <br>
        </p>
        <p>클래스는 설정에서 언제든지 추가가 할수 있습니다.</p>
    </div>
    <div class="detailSelectBox">
        <label>a) 나의 업무시간 설정</label>
        <div class="dropdown">
            <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">선택<span class="caret"></span></button>
            <ul id="myWorkTimeStart" class="dropdown-menu">
              <li><a data-time="0">오전 0시</a></li>
              <li><a data-time="1">오전 1시</a></li>
              <li><a data-time="2">오전 2시</a></li>
              <li><a data-time="3">오전 3시</a></li>
              <li><a data-time="4">오전 4시</a></li>
              <li><a data-time="5">오전 5시</a></li>
              <li><a data-time="6">오전 6시</a></li>
              <li><a data-time="7">오전 7시</a></li>
              <li><a data-time="8">오전 8시</a></li>
              <li><a data-time="9">오전 9시</a></li>
              <li><a data-time="10">오전 10시</a></li>
              <li><a data-time="11">오전 11시</a></li>
              <li><a data-time="12">오후 12시</a></li>
              <li><a data-time="13">오후 1시</a></li>
              <li><a data-time="14">오후 2시</a></li>
              <li><a data-time="15">오후 3시</a></li>
              <li><a data-time="16">오후 4시</a></li>
              <li><a data-time="17">오후 5시</a></li>
              <li><a data-time="18">오후 6시</a></li>
              <li><a data-time="19">오후 7시</a></li>
              <li><a data-time="20">오후 8시</a></li>
              <li><a data-time="21">오후 9시</a></li>
              <li><a data-time="22">오후 10시</a></li>
              <li><a data-time="23">오후 11시</a></li>
            </ul>
        </div>
        <div class="dropdown">
            <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">선택<span class="caret"></span></button>
            <ul id="myWorkTimeEnd" class="dropdown-menu">
              
            </ul>
        </div>

        <label>b) 나의 회원님 예약 기능 여부</label>
        <p>OFF로 설정시 나의 회원님은 스케쥴 확인만 가능하고,<br> 예약 및 취소는 불가능 합니다.</p>
        <button class="reserveOnOffToggle" data-onoff='0'>회원 예약 기능 켜기</button>
        <button class="reserveOnOffToggle" data-onoff='1'>회원 예약 기능 끄기</button>

        <div class="memberConnectSettingBox">
          <label>c) 나의 회원님 예약 가능 시간대</label>
          <p>나의 회원님께서 일정을 예약하거나 취소할 수 있는 시간대를 설정합니다.</p>
          <div class="dropdown">
              <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">선택<span class="caret"></span></button>
              <ul id="myReserveTimeStart" class="dropdown-menu">
                <li><a data-time="0">오전 0시</a></li>
                <li><a data-time="1">오전 1시</a></li>
                <li><a data-time="2">오전 2시</a></li>
                <li><a data-time="3">오전 3시</a></li>
                <li><a data-time="4">오전 4시</a></li>
                <li><a data-time="5">오전 5시</a></li>
                <li><a data-time="6">오전 6시</a></li>
                <li><a data-time="7">오전 7시</a></li>
                <li><a data-time="8">오전 8시</a></li>
                <li><a data-time="9">오전 9시</a></li>
                <li><a data-time="10">오전 10시</a></li>
                <li><a data-time="11">오전 11시</a></li>
                <li><a data-time="12">오후 12시</a></li>
                <li><a data-time="13">오후 1시</a></li>
                <li><a data-time="14">오후 2시</a></li>
                <li><a data-time="15">오후 3시</a></li>
                <li><a data-time="16">오후 4시</a></li>
                <li><a data-time="17">오후 5시</a></li>
                <li><a data-time="18">오후 6시</a></li>
                <li><a data-time="19">오후 7시</a></li>
                <li><a data-time="20">오후 8시</a></li>
                <li><a data-time="21">오후 9시</a></li>
                <li><a data-time="22">오후 10시</a></li>
                <li><a data-time="23">오후 11시</a></li>
              </ul>
          </div>
          <div class="dropdown">
              <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">선택<span class="caret"></span></button>
              <ul id="myReserveTimeEnd" class="dropdown-menu">

              </ul>
          </div>

          <label>d) 근접 예약/취소 설정</label>
          <p>내 회원님이 약속된 시간에 임박해서 예약을 하거나 <br> 취소하는 것을 방지합니다.</p>
          <p>ex)'2시간전' 설정시 17:00에 예약하기 위해서는 <br> 적어도 15:00 전에 예약 혹은 취소해야합니다.</p>
          <div class="dropdown">
              <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">선택<span class="caret"></span></button>
              <ul id="myReserveProhibitTime" class="dropdown-menu">
                  <li><a data-time="1">1시간 전</a></li>
                  <li><a data-time="2">2시간 전</a></li>
                  <li><a data-time="3">3시간 전</a></li>
                  <li><a data-time="4">4시간 전</a></li>
                  <li><a data-time="5">5시간 전</a></li>
                  <li><a data-time="6">6시간 전</a></li>
                  <li><a data-time="7">7시간 전</a></li>
                  <li><a data-time="8">8시간 전</a></li>
                  <li><a data-time="9">9시간 전</a></li>
                  <li><a data-time="10">10시간 전</a></li>
                  <li><a data-time="11">11시간 전</a></li>
                  <li><a data-time="12">12시간 전</a></li>
                  <li><a data-time="24">1일 전</a></li>
                  <li><a data-time="48">2일 전</a></li>
                  <li><a data-time="72">3일 전</a></li>
              </ul>
          </div>
        </div>

    </div>
    <button  onclick="goNext('-1')">이전</button>
    <button onclick="goNext('1')">완료</button>
</div>


{% endblock %}

{% block local_js_footer %}
        <!-- for db by hk.kim 170805-->
        <script>
          /*
          $('#popup_lecture_select').show().css('top','40%')
          ajax_read_lecture_info_from_db()
          */
          $('#pcver').css('background','#e2e2e2')
          $('.centermenu_text').css('color','#b1b1b1').attr('onclick','')
          $('#loginInfo').attr('onclick','')      
          $('.button_close_popup').hide()

          $('#upbutton').attr('onclick','')
          $('#upbutton img').css('opacity','0.2')

          $('.reserveOnOffToggle[data-onoff=0]').click(function(){
            $('.memberConnectSettingBox').show()
          })

          $('.reserveOnOffToggle[data-onoff=1]').click(function(){
            $('.memberConnectSettingBox').hide()
          })


          //시간 설정 관련 드랍다운 채우기

          /*드랍다운 설정*/
          $(document).on('click','.dropdown li a',function(){
              var selectedValue = $(this).attr('data-time')
              var selectedName  = $(this).text()
              $(this).parents('ul').siblings('button').val(selectedValue).text(selectedName)
          })
          /*드랍다운 설정*/

          /*과목 선택*/
          $(document).on('click','a[data-time=PL]',function(){
            $('#dropdown_subject_1').css('display','inline-block')
            $('#dropdown_subject_2').css('display','none')
          })

          $(document).on('click','a[data-time=TR]',function(){
            $('#dropdown_subject_1').css('display','none')
            $('#dropdown_subject_2').css('display','inline-block')
          })

          $(document).on('click','#subject_type_1 li a, #subject_type_2 li a',function(){
              var classcode = $(this).attr('data-time')
              $('#subject_cd').val(classcode)
          })

          $(document).on('click','#center_list li a',function(){
              var centercode = $(this).attr('data-time')
              $('#center_id').val(centercode)
          })
          /*과목 선택*/


          /*업무 시간 설정*/
          $("#myWorkTimeStart li a").click(function(){
                $("#myWorkTimeStart").siblings('button').addClass("dropdown_selected").text($(this).text()).val($(this).attr('data-time'));
                var availableTime = make_available_date_format($('#myWorkTimeStart'),$('#myWorkTimeEnd'))
                $('#id_setting_trainer_work_time').val(availableTime)
                fill_dropdown_reserve_endtime($(this).attr('data-time'),$('#myWorkTimeEnd'))
          });
          $(document).on('click',"#myWorkTimeEnd li a",function(){
                $("#myWorkTimeEnd").siblings('button').addClass("dropdown_selected").text($(this).text()).val($(this).attr('data-time'));
                var availableTime = make_available_date_format($('#myWorkTimeStart'),$('#myWorkTimeEnd'))
                $('#id_setting_trainer_work_time').val(availableTime)
          });
          /*업무 시간 설정*/

          /*회원 예약 허용 시간대 설정*/
          $("#myReserveTimeStart li a").click(function(){
                $("#myReserveTimeStart").siblings('button').addClass("dropdown_selected").text($(this).text()).val($(this).attr('data-time'));
                var availableTime = make_available_date_format($('#myReserveTimeStart'),$('#myReserveTimeEnd'))
                $('#id_setting_member_available_time').val(availableTime)
                fill_dropdown_reserve_endtime($(this).attr('data-time'),$('#myReserveTimeEnd'))

          });
          $(document).on('click',"#myReserveTimeEnd li a",function(){
                $("#myReserveTimeEnd").siblings('button').addClass("dropdown_selected").text($(this).text()).val($(this).attr('data-time'));
                var availableTime = make_available_date_format($('#myReserveTimeStart'),$('#myReserveTimeEnd'))
                $('#id_setting_member_available_time').val(availableTime)

          });
          /*회원 예약 허용 시간대 설정*/

          /*회원 근접 예약 금지*/
          $('#myReserveProhibitTime li a').click(function(){
              var prohibit_time = $(this).attr('data-time')
              $('#id_setting_member_reserve_time_prohibition').val(prohibit_time)
          })
          /*회원 근접 예약 금지*/


          $('.reserveOnOffToggle').click(function(){
              $(this).addClass('selected')
              $(this).siblings('.reserveOnOffToggle').removeClass('selected')
              $('#id_setting_member_reserve_prohibition').val($(this).attr('data-onoff'))
          })
          //시간 설정 관련 드랍다운 채우기


          function make_available_date_format(button1, button2){
              var starthour = button1.siblings('button').val()
              var endhour = button2.siblings('button').val()
              console.log(starthour,endhour)
              if(starthour == "24"){
                var starthour = "23:59"
              }else{
                var starthour = button1.siblings('button').val() + ':00'
              }
              if(endhour == "24"){
                var endhour = "23:59"
              }else{
                var endhour = button2.siblings('button').val() + ':00'
              }
              var availableTime = starthour+'-'+endhour
              return availableTime
          }

          function fill_dropdown_reserve_endtime(starttime, ultarget){
            var array = []
            for(var i=Number(starttime)+1; i<=24; i++){
              if(i==24){
                array.push('<li><a data-time="'+i+'">오전 12시</a></li>')   
              }else if(i<12){
                array.push('<li><a data-time="'+i+'">오전 '+i+'시</a></li>')   
              }else if(i==12){
                array.push('<li><a data-time="'+i+'">오후 '+i+'시</a></li>')   
              }else if(i>=12){
                array.push('<li><a data-time="'+i+'">오후 '+(i-12)+'시</a></li>')   
              }
            }
            ultarget.siblings('button').val('').text('')
            ultarget.html(array.join(''))
          }

          function goNext(option){
              if(option == "0"){
                if($('#subject_cd').val().length>0){
                  $('#myClassCreate').css('display','none')
                  $('#myClassSetting').css('display','block')
                }
              }else if(option == "1"){
                ajax_send_centercode_subjectcode()
              }else if(option == "-1"){
                $('#myClassCreate').css('display','block')
                $('#myClassSetting').css('display','none')
              }else if(option == "home"){
                location.href="{% url 'trainer:index' %}"
              }
          }

          function ajax_send_centercode_subjectcode(){
            console.log($('#add-class-info-form').serialize())
              $.ajax({
                  url: '/trainer/add_class_info/',
                  data: $('#add-class-info-form').serialize(),
                  dataType : 'html',
                  type : 'post',

                  beforeSend:function(){
                    $('html').css("cursor","wait");
                  },

                  success:function(data){
                      console.log(data)
                    var jsondata = JSON.parse(data)
                    if(jsondata.messageArray.length>0){
                        $('#errorMessageBar').show()
                        $('#errorMessageText').text(jsondata.messageArray)
                    }else{
                      ajax_send_reserve_initial_setting()
                    }
                  },
                  complete:function(){
                    $('html').css("cursor","auto");
                  },

                  error:function(){
                    $('#errorMessageBar').show()
                    $('#errorMessageText').text('통신 에러: 관리자 문의')
                  }
              })
          }

          function ajax_send_reserve_initial_setting(){
              $.ajax({
                  url: '/trainer/update_setting_reserve/',
                  data: $('#update-setting-reserve-form').serialize(),
                  dataType : 'html',
                  type : 'post',

                  beforeSend:function(){
                    $('html').css("cursor","wait");
                  },

                  success:function(data){
                    var jsondata = JSON.parse(data)
                    if(jsondata.messageArray.length>0){
                        $('#errorMessageBar').show()
                        $('#errorMessageText').text(jsondata.messageArray)
                    }else{
                      alert('새로운 강의가 등록 되었습니다.')
                      location.href="{% url 'trainer:trainer_main' %}"
                    }
                  },
                  complete:function(){
                    $('html').css("cursor","auto");
                  },

                  error:function(){
                      $('#errorMessageBar').show()
                      $('#errorMessageText').text('통신 에러: 관리자 문의')
                  }
              })
          }

        </script>

{% endblock %}
