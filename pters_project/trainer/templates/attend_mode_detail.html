<!DOCTYPE html>
<html lang="en" class="pters_{{request.session.setting_theme}}_mode">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="google-site-verification" content="EPm2stOoq7M_LaK0htEQNqbitGznovZCakPO78TPtsk" />
    <meta name="naver-site-verification" content="919ceda7d377b0d22cf390ca79de5dc21dc3d0fa"/>
    <meta name="description" content="PTERS 피터스 PT, 요가, 필라테스, 당구, 골프 등 레슨 회원관리와 일정을 관리하는 서비스 프로그램">

    <title>PTERS-출석체크모드</title>
    {% load static_url %}
    <link rel="icon" href="/static/common/favicon.ico">
    <link rel="apple-touch-icon" href="/static/common/favicon-48.png">
    <link rel="shortcut icon" href="/static/common/favicon-48.png">
    <link rel="stylesheet" href={% static_url "user/css/trainer/pters.trainer.base.css" %}>
    <link rel="stylesheet" href={% static_url "user/css/trainer/popup/pters.trainer.popup.base.css" %}>
    <style type="text/css">
        @import url(/static/common/fonts/notosanskr.css);

        html,body{
            font-family: 'Noto Sans KR',sans-serif !important;
        }


        html{
            font-size: 10px;
        }
        body{
            margin: 0;
        }
        @media(min-width:768px){
            html{
                font-size: 14px;
            }
        }
        p{
            margin-top: 10px;
            margin-bottom: 10px;
        }
        section{
            width: 100%;
            box-sizing: border-box;
        }
        button{
            border: 0;
            background-color: #ffffff;
            height: 35px;
            padding: 5px 10px;
            min-width: 50px;
            cursor: pointer;
        }

        #content_wrapper{
            /* position: fixed;
            display: none;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 650px;
            margin: 0 auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; */
            position: relative;
            display: none;
            width: 100%;
            height: 100%;
            max-width: 650px;
            margin: 0 auto;
            /* overflow-y: auto; */
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        #wrapper_lesson_now{
            background-color: #ffffff;
            border-radius: 5px;
        }
        #wrapper_arrow_button{
            position: relative;
            height: 35px;
            padding: 20px 0;
        }
        #wrapper_arrow_button .left_button_set{
            float: left;
        }
        #wrapper_arrow_button .right_button_set{
            float: right;
        }

        #wrapper_page_title{
            padding: 0 20px;
            text-align: center;
        }
        #wrapper_page_title > span{
            font-size:22px;
            font-weight:bold;
            color:#3d3b3b;
            letter-spacing:-0.1px;
        }

        #wrapper_lesson_now_info{
            margin: 0 auto;
            /* max-width: 550px; */
            padding: 15px;
            box-sizing: border-box;
            text-align: center
        }
        #wrapper_lesson_now_info_name{
            padding: 10px;
            box-shadow:  0 0 16px 0 #e6e6e6;
            border: 1px solid #f5f2f3;
            border-radius: 4px;
        }
        #wrapper_lesson_now_info_name .lesson_date{
            font-size: 12px;
            font-weight: 500;
            letter-spacing: -0.5px;
            color: #3d3b3b;
        }
        #wrapper_lesson_now_info_name .lesson_name{
            font-size: 15px;
            font-weight: bold;
            letter-spacing: -0.7px;
            color: #3d3b3b;
        }

        .title_tag{
            font-size: 11px;
            font-weight: 500;
            color: #999696;
            letter-spacing: -0.5px;
            text-align: left;
        }
    
        /* attend_mode_detail */
        
        #wrapper_submit_button{
            text-align: center;
            padding: 20px;
        }
        #wrapper_submit_button > button{
            width: 100%;
            height: 52px;
            background-color: #fe4e65;
            color: #ffffff;
            font-size: 15px;
            font-weight: bold;
            letter-spacing: -0.7px;
        }

        #button_setting{
            border: 0;
            background-color: transparent;
        }

        #button_back{
            border: 0;
            background-color: transparent;
        }

        #wrapper_ticket_change_info{
            text-align: center
        }
        #img_ticket_change_arrow{
            transform: rotate(90deg);
            width: 15px;
        }

        /* attend_mode_detail */

        /* 팝업 */
        .popup{
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1500;
            width: 90%;
            max-width: 500px;
            background-color: #ffffff;
            border: 1px solid #cccccc;
            padding: 20px;
            text-align: center
        }
        .popup > div{
            margin: 10px 0;
        }
        .popup input{
            -webkit-appearance: none;
            border: 1px solid #cccccc;
            border-radius: 0;
            width: 150px;
            height: 30px;
            
        }
        .popup button{
            width: 100px;
            margin: 5px;
        }
        .popup_shade{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #282828;
            opacity: 0.5;
        }
        /* 팝업 */

        .ajax_loading_image{
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 35px;
            z-index: 1500;
        }

        .fts_24{font-size: 1.7rem;}
        .fts_22{font-size: 1.5rem;}
        .fts_20{font-size: 1.4rem;}
        .fts_18{font-size: 1.28rem;}
        .fts_16{font-size: 1.14rem;}

        .ftw_bd{font-weight: bold;}
        .ftw_500{font-weight: 500;}

        .ftc_pink{color: #fe4e65}
    </style>
</head>

<body>
    <div id="debug" style="position:fixed;z-index: 1500;top:0;left:0;" hidden>
        <span id="debug_x">x:</span><span id="debug_x_value"></span>
        <span id="debug_y">y:</span><span id="debug_y_value"></span>
        <span id="debug_offset"></span>
    </div>
    <img src={% static_url "common/loading.svg" %} alt="" class="ajax_loading_image">
    <div id="shade_for_popup_basic" style="position: absolute;;top:0;left:0;height:100%;width:100%;background-color:#282828;opacity:0.5; display: none;" 
        onclick="layer_popup.close_layer_popup();"></div>

    <div id="content_wrapper">
        
        <section id="wrapper_lesson_now">
            <div id="wrapper_arrow_button">
                <div class="left_button_set">
                    <button id="button_back" onclick="location.href='/trainer/attend_mode/'">
                        <img src="/static/common/icon/icon_x_black.png" style="width:25px; height:25px;">
                    </button>
                </div>
                <div class="right_button_set">
                    <!-- <button onclick="location.reload();" style="border:0;">
                        <img src="/static/common/icon/icon_refresh_black.png" style="width:20px; height:20px;">
                    </button> -->
                </div>
            </div>

            <div id="wrapper_page_title">
                <span>{% if member_info %}
                        {{ member_info.name }} 님
                    {% else %}
                        휴대폰 번호를 확인해주세요.
                    {% endif %}</span>
            </div>

            <div id="wrapper_lesson_now_info">

                <p class="title_tag" style="text-align:center">선택한 수업</p>
                <div id="wrapper_lesson_now_info_name">
                    <p class="lesson_date">{{ schedule_info.start_dt | date:"Y.m.d (l)" |cut:"요일" }} {{ schedule_info.start_dt | time:"H:i" }} - {{ schedule_info.end_dt | time:"H:i" }}</p>
                    <p class="lesson_name">
                        {% if schedule_info.lecture_tb %}
                            [그룹] {{ schedule_info.lecture_tb.name }}
                        {% else %}
                            [개인] 개인 수업
                        {% endif %}
                   </p>
                </div>
            </div>

            <div id="wrapper_ticket_change_info">
                <p class="title_tag" style="text-align:center">출석시 다음과 같이 수강권이 차감됩니다.</p>
                <p class="fts_20">
{#                    {% if member_ticket_info.ticket_tb.ticket_type_cd == 'PACKAGE' %}#}
{#                        [패키지]#}
{#                    {% elif member_ticket_info.ticket_tb.ticket_type_cd == 'GROUP' %}#}
{#                        [그룹]#}
{#                    {% else %}#}
{#                        [개인]#}
{#                    {% endif %}#}
                    {{ member_ticket_info.ticket_tb.name }} ({{ member_ticket_info.member_ticket_rem_count }} / {{ member_ticket_info.member_ticket_reg_count }})</p>
                <div><img src="/static/user/res/btn_next.png" id="img_ticket_change_arrow"></div>
                <p class="fts_22 ftw_bd">
{#                    {% if member_ticket_info.ticket_tb.ticket_type_cd == 'PACKAGE' %}#}
{#                        [패키지]#}
{#                    {% elif member_ticket_info.ticket_tb.ticket_type_cd == 'GROUP' %}#}
{#                        [그룹]#}
{#                    {% else %}#}
{#                        [개인]#}
{#                    {% endif %}#}
                    {{ member_ticket_info.ticket_tb.name }} ({{ member_ticket_info.member_ticket_rem_count|add:"-1" }} / {{ member_ticket_info.member_ticket_reg_count }})</p>
            </div>
        </section>


        <section id="wrapper_submit_button">
            <button onclick="form_confirm(event, 'signature')" id="button_confirm_attend" class="fts_22 ftw_bd">출석</button>
        </section>

        <form action="{% url 'trainer:attend_mode_finish' %}" id="form_attend_data" method="post">
            <div style="display:none;">{% csrf_token %}
            <input type="hidden" name="member_id" value="{{ member_id }}">
            <input type="hidden" name="schedule_id" value="{{ schedule_id }}">
            </div>
        </form>

        <div id="popup_storage">
            {% include 'popup/trainer_popup_basic.html' %}
            {% include 'popup/trainer_popup_user_input.html' %}
        </div>
    </div>

    
   
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script type="text/javascript" src={% static_url "user/js/trainer/pters.trainer.component.common.js" %}></script>
    <script type="text/javascript" src={% static_url "user/js/trainer/pters.trainer.const.js" %}></script>
    <script type="text/javascript" src={% static_url "user/js/trainer/pters.trainer.popup.behavior.js" %}></script>
    <script type="text/javascript" src={% static_url "user/js/trainer/popup/pters.trainer.popup.base.js" %}></script>
    <script type="text/javascript" src={% static_url "user/js/trainer/pters.trainer.selectors.js" %}></script>

    <script>
        window.onload=function(){
            let window_height = window.innerHeight;
            let content_height = $('#content_wrapper').height();

            $('#content_wrapper').fadeIn();
            if(content_height < window_height-10){
                // $('#content_wrapper').css({'left':'50%', 'top':'50%', 'transform':'translate(-50%, -50%)'})
                
            }else{
                $('#content_wrapper').css({'height': window_height});
            }

            func_set_webkit_overflow_scrolling('#content_wrapper');
        }
        var $root_content = $('#content_wrapper');

        //유저가 터치인지 마우스 사용인지 알아낸다
        var touch_or_mouse = "";
        window.addEventListener('touchstart', function(){
            touch_or_mouse = "touch";
        });
        //유저가 터치인지 마우스 사용인지 알아낸다
            

        function form_confirm(e, type){
            e.preventDefault();
            let root_content_height = $(window).height();
            layer_popup.open_layer_popup(POPUP_BASIC, POPUP_ADDRESS_DRAWING_BOARD, 100*315/root_content_height, POPUP_FROM_BOTTOM, null, ()=>{
                let data = {    title:"일정 완료 서명",
                                description:"완료 서명을 입력해주세요.",
                                width: $root_content.width() <= 500 ? $root_content.width() : 500,
                                height:250,
                                color:{pencil:"#ffffff", paper:"#282828"},
                                border:0,
                                callback:(data)=>{
                                    let image_data = data;
                                    complete_this_plan(image_data);
                                }
                            };
                drawing_board = new DrawingBoard('#wrapper_box_drawing_board', "drawing_board", data);
            });
        }


        function complete_this_plan(image_data){
            // let drawCanvas = document.getElementById('canvas');
            let send_data = $('#form_attend_data').serializeArray();
            send_data.push({"name":"upload_file", "value":image_data});
            signImageSend(send_data, ()=>{
                // location.href='/trainer/attend_mode/';
            });
        }


        function signImageSend(send_data, callback){
            $.ajax({
                url:'/schedule/upload_sign_image/',
                type:'POST',
                data:send_data,

                beforeSend:function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                    ajax_load_image(SHOW);
                },

                //통신성공시 처리
                success:function(data){
                    var jsondata = JSON.parse(data);
                    check_app_version(jsondata.app_version);
                    if(jsondata.messageArray.length>0){
                        $('#errorMessageBar').show();
                        $('#errorMessageText').text(jsondata.messageArray);
                    }else{
                        console.log('sign_image_save_success');
                        $('#form_attend_data').submit();
                    }

                    if(callback != undefined){
                        callback();
                    }
                },

                //보내기후 팝업창 닫기
                complete:function(){
                    ajax_load_image(HIDE);
                },

                //통신 실패시 처리
                error:function(){
                    alert("Server Error: \nSorry for inconvenience. \nPTERS server is unstable now.");
                    console.log('sign_image_save_fail');
                }
            })
        }
    </script>

    <script>
        var session_app_version = `{{ APP_VERSION }}`;
        //기기종류 판단
        const varUA = navigator.userAgent.toLowerCase();
        let os = "IOS";
        if (varUA.match(/android/) != null) {
            os = "ANDROID";
        }else if (varUA.match(/iphone/) != null || varUA.match(/ipad/) != null || varUA.match(/ipod/) != null) {
            os = "IOS";
        }else if (varUA.match(/macintosh/) != null){
            os = "IOS";
        }else{
            os = "WINDOW";
        }
        
        function func_set_webkit_overflow_scrolling(target_selector){
            if(os == "IOS"){
                let $selector = $(target_selector);
                $selector.scrollTop(1);
                $selector.scroll(function(e){
                    const popupHeight = $selector.height();
                    const scrollHeight = $selector.prop('scrollHeight');
                    const scrollLocation = $selector.scrollTop();
                    if(scrollHeight > popupHeight+1){
                    if(popupHeight + scrollLocation == scrollHeight){
                            $selector.animate({scrollTop : scrollLocation-1}, 10);
                        }else if(popupHeight + scrollLocation == popupHeight){
                            $selector.animate({scrollTop : scrollLocation+1}, 10);
                        }
                    }
                    
                });
            }
        }

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');

        function ajax_load_image(option){
            let $ajax_load_image = $('img.ajax_loading_image');
            switch(option){
                case SHOW:
                    $ajax_load_image.show();
                break;

                case HIDE:
                    $ajax_load_image.hide();
                break;
            }
        }



        function update_push_token(token, device_id) {
            $.ajax({
                url:'/login/add_push_token/',
                type:'POST',
                data:{"token_info":token, "device_id":device_id},
                dataType : 'html',

                beforeSend:function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                    //AjaxBeforeSend();
                },

                //통신성공시 처리
                success:function(data_){
                    let data = JSON.parse(data_);
                    check_app_version(data.app_version);
                    // $('a.text-payment').parent('div').css('display', 'inline-block');
                    // if(device_id != 'pc') {
                        // $('a.text-payment').parent('div').css('display', 'none');
                        // $('.ads_wrap').css('display', 'none');
                        // $('.sidebar_div_last2 a').attr('href', '/trainer/help_setting/').attr('target', '');
                        // $('#paymentSetting').css('display', 'none');
                        // $('._company').css('display', 'none');
                    // }else{
                        // $('a.text-payment').parent('div').css('display', 'inline-block');
                    // }
                    console.log('토큰 등록 완료');
                },

                //보내기후 팝업창 닫기
                complete:function(){

                },

                //통신 실패시 처리
                error:function(){

                }
            });
        }

        function check_app_version(app_version){
            if(app_version != undefined){
                if(session_app_version != app_version){
                    location.reload();
                }
            }
        }
    </script>
</body>
</html>

