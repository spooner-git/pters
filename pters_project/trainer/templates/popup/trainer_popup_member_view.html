{% extends "popup/trainer_base_popup_pagetype.html" %}
{% load static_url %}
{% load background_trainee_data %}

{% block popup_base_css %}
    <!-- pters.trainee.popup.plan_view.css -->
    <link rel="stylesheet" href={% static_url "user/css/trainer/popup/pters.trainer.popup.member_view.css" %}>
{% endblock %}

{% block popup_base_wrapper_top_center %}
<span id="member_name_in_popup"></span>
{% endblock %}

{% block popup_base_wrapper_top_right %}
<span id="member_edit_popup_show_button">설정</span>
{% endblock %}

{% block popup_base_contents %}
    <div class="popup_member_view">
        <div id="wrapper_box_member_info">
    
        </div>

        <div class="gap"></div>

        <div id="wrapper_box_member_tickets">
            <div class="obj_box_full">
                <div id="toggle_set_ticket_in_member">
                    
                </div>
            </div>
            <div class="obj_box_full" style="padding: 0;">
                <div id="wrapper_member_tickets_list" class="swiper-container">
                    
                </div>
            </div>
        </div>

        <div class="gap"></div>

        <div id="wrapper_box_member_lectures">
            <div class="obj_box_full">
                <div id="toggle_set_lecture_in_member">
                        
                </div>
            </div>
            <div class="obj_box_full" style="padding: 0;">
                <div id="wrapper_member_lectures_list">
                    
                </div>
            </div>
        </div>

        <div class="gap"></div>
        <div class="gap"></div>

    </div>
{% endblock %}

{% block popoup_base_wrapper_bottom_inside %}
    {% now "Y-m-d" as todays_date %}

    {% if date_format|date:"Y-m-d" >= todays_date and avail_end_date|date:"Y-m-d" >= date_format|date:"Y-m-d"%}
        <!-- <div class="obj_button_big obj_font_bg_white_coral" onclick="layer_popup.open_layer_popup(POPUP_AJAX_CALL, 'popup_calendar_plan_reserve', 90, POPUP_FROM_BOTTOM, {'select_date':'{{ date_format| date:'Y-m-d' }}'})">예약 추가하기</div> -->
    {% else %}
        <!-- <div class="obj_button_big obj_font_bg_pink_white" onclick="layer_popup.all_close_layer_popup()">확인</div> -->
    {% endif %}
{% endblock %}

{% block popup_base_js %}

<script>

    {% autoescape off %}
    let member_basic_info = {{ member_info }};
    let member_ticket_list = {{ member_ticket_list }};
    let member_lecture_list = {{ member_lecture_list }};
    let member_info = {basic_info: member_basic_info, ticket_info: member_ticket_list, lecture_info: member_lecture_list};
    {% endautoescape %}

    function toggle_list(target_selector){
        let $target = $(target_selector);
        let status = $target.attr('data-toggle');
        if(status == 0){
            $target.show(100);
            $target.attr('data-toggle', 1);
        }else if(status == undefined || status == 1){
            $target.hide(100);
            $target.attr('data-toggle', 0);
        }
    }

    class Member_info{
        constructor(targetHTML, data, instance){
            this.targetHTML = targetHTML;
            this.instance = instance;
            this.data = data;
            
            this.target_basic_info = '#wrapper_box_member_info';
            this.target_name = '#member_name_in_popup';
            this.target_ticket_list = '#wrapper_member_tickets_list';
            this.target_lecture_list = '#wrapper_member_lectures_list';

        }

        init (){
            this.render_basic_info();
            this.render_member_name();
            this.render_member_edit_button('#member_edit_popup_show_button');
            this.render_ticket_list_set();
            this.render_lecture_list_set();
        }

        refresh(data){
            this.reform_data(data);
            this.render_member_name();
            this.render_basic_info();
        }

        reform_data(data){
            //basic_info 만 reform
            this.data.basic_info = data;
        }

        render_ticket_list_set (){
            this.render_static_component('#toggle_set_ticket_in_member', "toggle_set_ticket");
            this.render_include_ticket_info();
        }

        render_lecture_list_set (){
            this.render_static_component('#toggle_set_lecture_in_member', "toggle_set_lecture");
            this.render_include_lecture_info();
        }

        render_member_name (target){
            if(target == undefined){
                target = this.target_name;
            }
            console.log("123", this.data)
            document.querySelector(target).innerHTML = this.data.basic_info.member_name;
        }

        render_member_edit_button (target){
            document.querySelector(target).onclick = () => {
                // open_member_edit_popup(this.data.basic_info.member_id);
                layer_popup.open_layer_popup(POPUP_AJAX_CALL, POPUP_ADDRESS_MEMBER_EDIT, 100, POPUP_FROM_RIGHT, {'member_id':this.data.basic_info.member_id});
            }
        }

        render_basic_info (target){
            if(target == undefined){
                target = this.target_basic_info;
            }
            let html = `
                        <div class="obj_box_full">
                            <div id="wrapper_member_info_basic">
                                <div>
                                    ${this.data.basic_info.member_is_active == 'False'
                                    ?"<img src='/static/common/icon/icon_link_off.png' class='obj_icon_basic icon_link'>(임시아이디)" 
                                    :"<img src='/static/common/icon/icon_link_on.png' class='obj_icon_basic icon_link'>" }
                                    ${this.data.basic_info.member_user_id}
                                </div>
                                <div>${this.data.basic_info.member_sex == "None" ? "성별 미입력" : this.data.basic_info.member_sex}</div>
                                <div>${this.data.basic_info.member_phone == "None" ? "전화번호 미입력" : this.data.basic_info.member_phone}</div>
                            </div>
                            <div id="wrapper_member_info_dates">
                                <div>수정 <span>${'%%2019.06.24'}</span></div>
                                <div>개설 <span>${'%%2019.06.21'}</span></div>
                            </div>
                        </div
                        >
                        `;
            document.querySelector(target).innerHTML = html;
        }

        render_include_ticket_info (target){
            if(target == undefined){
                target = this.target_ticket_list;
            }
            let html_to_join = [];
            for(let ticket in this.data.ticket_info){
                let this_data = this.data.ticket_info[ticket];
                let ticket_id = this_data.member_ticket_ticket_id;
                let ticket_name = this_data.member_ticket_name;
                let ticket_reg_count = this_data.member_ticket_reg_count;
                let ticket_rem_count = this_data.member_ticket_rem_count
                let ticket_end = this_data.member_ticket_end_date;
                let html = 
                            `
                            <div class="swiper-slide" onclick="layer_popup.open_layer_popup(POPUP_AJAX_CALL, POPUP_ADDRESS_TICKET_VIEW, 100, POPUP_FROM_RIGHT, {'ticket_id':${ticket_id}})">
                                <div class="ticket_swiper_element_wrap">
                                    <div class="ticket_swiper_element_wrap_inner">
                                        <div>
                                            <div class="obj_tag obj_font_bg_grey_trans" style="line-height: 20px;">${'횟수제'}</div>
                                        </div>
                                        <div>
                                            <div class="obj_font_size_14_weight_normal">${ticket_name}</div>
                                        </div>
                                        <div>
                                            <span class="obj_font_size_11_weight_normal obj_font_color_dark_grey">${ticket_end}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `;
                html_to_join.push(html);
            }

            document.querySelector(target).innerHTML = `<div class="swiper-wrapper">${html_to_join.join('')}</div>`;
        }

        render_include_lecture_info (target){
            if(target == undefined){
                target = this.target_lecture_list;
            }
            let html_to_join = [];
            for(let lecture in this.data.lecture_info){
                let this_data = this.data.lecture_info[lecture];
                let lecture_id = this_data.lecture_id;
                let lecture_name = this_data.lecture_name;
                let lecture_max_num = this_data.lecture_max_num;
                let html = 
                            `
                            <li onclick="layer_popup.open_layer_popup(POPUP_AJAX_CALL, POPUP_ADDRESS_LECTURE_VIEW, 100, POPUP_FROM_RIGHT, {'lecture_id':${lecture_id}})">
                                <div class="lecture_data_l">
                                    <div class="lecture_tag_body" style="background:#fe4e65"></div>
                                    <div class="lecture_tag_head" style="border-left-color:#fe4e65"></div>
                                </div>
                                <div class="lecture_data_c">
                                    <div class="lecture_name">${lecture_name}</div>
                                </div>
                                <div class="lecture_data_r">
                                    <div class="lecture_member_number">정원 - ${lecture_max_num}명
                                    </div>
                                </div>
                            </li>
                            `;
                html_to_join.push(html);
            }
            document.querySelector(target).innerHTML = `<ul>${html_to_join.join('')}</ul>`;           
        }

        render_static_component (target, component_name){
            document.querySelector(target).innerHTML = this.static_component()[component_name];
        }


        static_component (){
            return {
                    toggle_set_ticket : `<div id="toggle_member_tickets_list" onclick="toggle_list('#wrapper_member_tickets_list')">
                                            <span>진행중인 수강권 ${Object.keys(this.data.ticket_info).length}</span>
                                            <img src="/static/common/icon/expand_less_black.png" alt="펼치기/접기" class="obj_icon_expand">
                                        </div>`,
                    toggle_set_lecture: `<div id="toggle_member_lectures_list" onclick="toggle_list('#wrapper_member_lectures_list')">
                                            <span>참여가능 수업 ${Object.keys(this.data.lecture_info).length}</span>
                                            <img src="/static/common/icon/expand_less_black.png" alt="펼치기/접기" class="obj_icon_expand">
                                        </div>`
            };
        }

    }

    let swiper;
    var member_info_popup = new Member_info('.popup_member_view', member_info, 'member_info_popup');
    member_info_popup.init();
    swiper = new Swiper('.swiper-container', {
      slidesPerView: 2,
      spaceBetween: 0,
    });



    func_set_webkit_overflow_scrolling('.popup_member_view');
</script>
{% endblock %}
