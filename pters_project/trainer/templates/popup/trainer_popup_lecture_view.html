{% extends "popup/trainer_base_popup_pagetype.html" %}
{% load static_url %}
{% load background_trainee_data %}

{% block popup_base_css %}
    <!-- pters.trainee.popup.plan_view.css -->
    <link rel="stylesheet" href={% static_url "user/css/trainer/popup/pters.trainer.popup.lecture_view.css" %}>
{% endblock %}

{% block popup_base_wrapper_top_center %}
<span id="lecture_name_in_popup"></span>
{% endblock %}

{% block popup_base_wrapper_top_right %}
<span id="lecture_edit_popup_show_button">설정</span>
{% endblock %}

{% block popup_base_contents %}
    <div class="popup_lecture_view">
        <div id="wrapper_box_lecture_info">
    
        </div>

        <div class="gap"></div>

        <div id="wrapper_box_lecture_tickets">
            <div class="obj_box_full">
                <div id="toggle_set_ticket">
                    
                </div>
            </div>
            <div class="obj_box_full" style="padding: 0;">
                <div id="wrapper_lecture_tickets_list" class="swiper-container">
                    
                </div>
            </div>
        </div>

        <div class="gap"></div>

        <div id="wrapper_box_lecture_members">
            <div class="obj_box_full">
                <div id="toggle_set_member">
                        
                </div>
            </div>
            <div class="obj_box_full" style="padding: 0;">
                <div id="wrapper_lecture_members_list">
                    
                </div>
            </div>
        </div>

        <div class="gap"></div>
        <div class="gap"></div>

    </div>
{% endblock %}

{% block popoup_base_wrapper_bottom_inside %}
    {% now "Y-m-d" as todays_date %}

    {% if date_format|date:"Y-m-d" >= todays_date and avail_end_date|date:"Y-m-d" >= date_format|date:"Y-m-d"%}
        <!-- <div class="obj_button_big obj_font_bg_white_coral" onclick="layer_popup.open_layer_popup(POPUP_AJAX_CALL, 'popup_calendar_plan_reserve', 90, POPUP_FROM_BOTTOM, {'select_date':'{{ date_format| date:'Y-m-d' }}'})">예약 추가하기</div> -->
    {% else %}
        <!-- <div class="obj_button_big obj_font_bg_pink_white" onclick="layer_popup.all_close_layer_popup()">확인</div> -->
    {% endif %}
{% endblock %}

{% block popup_base_js %}

<script>

    {% autoescape off %}
    let lecture_info = {{ lecture_info }};
    {% endautoescape %}
    
    function toggle_list(target_selector){
        let $target = $(target_selector);
        let status = $target.attr('data-toggle');
        if(status == 0){
            $target.show(100);
            $target.attr('data-toggle', 1);
        }else if(status == undefined || status == 1){
            $target.hide(100);
            $target.attr('data-toggle', 0);
        }
    }

    class Lecture_info{
        constructor(targetHTML, instance, data){
            this.targetHTML = targetHTML;
            this.instance = instance;
            this.data = data;
            
            this.target_basic_info = '#wrapper_box_lecture_info';
            this.target_name = '#lecture_name_in_popup';
            this.target_member_list = '#wrapper_lecture_members_list';
            this.target_ticket_list = '#wrapper_lecture_tickets_list';
        }

        init(){
            this.render_basic_info();
            this.render_lecture_name();
            this.render_lecture_edit_button('#lecture_edit_popup_show_button');
            this.render_member_list_set();
            this.render_ticket_list_set();
        }

        refresh(data){
            this.reform_data(data);
            this.render_lecture_name();
            this.render_basic_info();
        }

        reform_data(data){
            this.data = data;
        }

        render_member_list_set(){
            this.render_static_component('#toggle_set_member', "toggle_set_member");
            this.render_include_member_info();
        }

        render_ticket_list_set(){
            this.render_static_component('#toggle_set_ticket', "toggle_set_ticket");
            this.render_include_ticket_info();
        }

        render_lecture_name(target){
            if(target == undefined){
                target = this.target_name;
            }
            document.querySelector(target).innerHTML = this.data.lecture_name;
        }

        render_lecture_edit_button(target){
            document.querySelector(target).onclick =  () => {
                layer_popup.open_layer_popup(POPUP_AJAX_CALL, POPUP_ADDRESS_LECTURE_EDIT, 100, POPUP_FROM_RIGHT, {'lecture_id':this.data.lecture_id})
            };
        }

        render_basic_info(target){
            if(target == undefined){
                target = this.target_basic_info;
            }
            let html = `
                        <div class="obj_box_full">
                            <div id="wrapper_lecture_info_basic">
                                <div style="position:relative;height:40px;">
                                    <div class="lecture_tag_body" style="background-color:#fe4e65"></div>
                                    <div class="lecture_tag_head" style="border-left-color:#fe4e65"></div>
                                </div>
                                <div>정원 - ${this.data.lecture_max_num} 명</div>
                                <div>${'30회 - 900,000 원'}</div>
                                <div>${this.data.lecture_note}</div>
                            </div>
                            <div id="wrapper_lecture_info_dates">
                                <div>수정 <span>${this.data.lecture_mod_dt}</span></div>
                                <div>개설 <span>${this.data.lecture_reg_dt}</span></div>
                            </div>
                        </div
                        >`
            document.querySelector(target).innerHTML = html;
        }

        render_include_ticket_info(target){
            if(target == undefined){
                target = this.target_ticket_list;
            }
            let html_to_join = [];
            let length = this.data.lecture_ticket_id_list.length;
            for(var i=0; i<length; i++){
                let ticket_id = this.data.lecture_ticket_id_list[i];
                let ticket_name = this.data.lecture_ticket_list[i]
                let html = 
                            `
                            <div class="swiper-slide" onclick="layer_popup.open_layer_popup(POPUP_AJAX_CALL, POPUP_ADDRESS_TICKET_VIEW, 100, POPUP_FROM_RIGHT, {'ticket_id':${ticket_id}})">
                                <div class="ticket_swiper_element_wrap">
                                    <div class="ticket_swiper_element_wrap_inner">
                                        <div>
                                            <div class="obj_tag obj_font_bg_grey_trans" style="line-height: 20px;">${'횟수제'}</div>
                                        </div>
                                        <div>
                                            <div class="obj_font_size_14_weight_normal">${ticket_name}</div>
                                        </div>
                                        <div>
                                            <span class="obj_font_size_11_weight_normal obj_font_color_dark_grey">2019.06.21</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `
                html_to_join.push(html);
            }
            document.querySelector(target).innerHTML = `<div class="swiper-wrapper">${html_to_join.join('')}</div>`;
        }

        render_include_member_info(target){
            if(target == undefined){
                target = this.target_member_list;
            }
            let html_to_join = [];
            let length = this.data.lecture_member_list.length;
            for(var i=0; i<length; i++){
                let data = this.data.lecture_member_list[i];
                let member_id = data.member_id;
                let member_name = data.member_name;
                let member_sex = data.member_sex;
                let member_rem = data.member_ticket_rem_count;
                let member_reg = data.member_ticket_reg_count;
                let html = 
                            `
                            <li onclick="layer_popup.open_layer_popup(POPUP_AJAX_CALL, POPUP_ADDRESS_MEMBER_VIEW, 100, POPUP_FROM_RIGHT, {'member_id':${member_id}});">
                                <div class="member_data_l">
                                    <img src="/static/common/icon/icon_account.png">
                                </div>                
                                <div class="member_data_c">
                                    <div class="member_name">${member_name}</div>
                                </div>
                                <div class="member_data_r">
                                    <div class="member_counts">잔여 ${member_rem}회</div>
                                </div>
                            </li>
                            `
                html_to_join.push(html);
            }
            document.querySelector(target).innerHTML = `<ul>${html_to_join.join('')}</ul>`;           
        }

        render_static_component(target, component_name){
            document.querySelector(target).innerHTML = this.static_component()[component_name];
        }


        static_component(){
            return {
                    toggle_set_ticket : `<div id="toggle_lecture_tickets_list" onclick="toggle_list('#wrapper_lecture_tickets_list')">
                                            <span>포함된 수강권 ${this.data.lecture_ticket_id_list.length}</span>
                                            <img src="/static/common/icon/expand_less_black.png" alt="펼치기/접기" class="obj_icon_expand">
                                        </div>`,
                    toggle_set_member: `<div id="toggle_lecture_members_list" onclick="toggle_list('#wrapper_lecture_members_list')">
                                            <span>진행중인 회원 ${this.data.lecture_member_list.length}</span>
                                            <img src="/static/common/icon/expand_less_black.png" alt="펼치기/접기" class="obj_icon_expand">
                                        </div>`
            }
        }

    }

    let swiper;
    var lecture_info_popup = new Lecture_info('.popup_lecture_view', 'lecture_info_popup', lecture_info);
    lecture_info_popup.init();
    swiper = new Swiper('.swiper-container', {
      slidesPerView: 2,
      spaceBetween: 0,
    });



    func_set_webkit_overflow_scrolling('.popup_lecture_view');
</script>
{% endblock %}
