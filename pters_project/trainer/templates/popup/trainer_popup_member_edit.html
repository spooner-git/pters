{% extends "popup/trainer_base_popup_pagetype.html" %}
{% load static_url %}
{% load background_trainee_data %}

{% block popup_base_css %}
    <!-- pters.trainee.popup.plan_view.css -->
    <link rel="stylesheet" href={% static_url "user/css/trainer/popup/pters.trainer.popup.member_edit.css" %}>
{% endblock %}

{% block popup_base_wrapper_top_center %}
<span id="ticket_name_in_popup">회원 설정</span>
{% endblock %}

{% block popup_base_wrapper_top_right %}

{% endblock %}

{% block popup_base_contents %}
    <div class="popup_member_edit">
    
        <div id="wrapper_box_member_settings" class="obj_box_full">
            
        </div>

        <div class="gap"></div>
        <div class="gap"></div>

    </div>
{% endblock %}

{% block popoup_base_wrapper_bottom_inside %}
    {% now "Y-m-d" as todays_date %}

    {% if date_format|date:"Y-m-d" >= todays_date and avail_end_date|date:"Y-m-d" >= date_format|date:"Y-m-d"%}
        <!-- <div class="obj_button_big obj_font_bg_white_coral" onclick="layer_popup.open_layer_popup(POPUP_AJAX_CALL, 'popup_calendar_plan_reserve', 90, POPUP_FROM_BOTTOM, {'select_date':'{{ date_format| date:'Y-m-d' }}'})">예약 추가하기</div> -->
    {% else %}
        <!-- <div class="obj_button_big obj_font_bg_pink_white" onclick="layer_popup.all_close_layer_popup()">확인</div> -->
    {% endif %}
{% endblock %}

{% block popup_base_js %}

<script>
    {% autoescape off %}
    let member_info = {{ member_info }};
    {% endautoescape %}


    class Member_edit{
        constructor(targetHTML, data, instance){
            this.targetHTML = targetHTML;
            this.instance = instance;
            this.data = data;

            this.member_id;
            this.member_name;
            this.member_user_id;
            this.member_phone;
            this.member_birth;
            this.member_sex;
            this.member_note;
            this.member_sync;

            this.items;
        }

        init(){
            this.reform_data(this.data);
            this.render_setting_list();
        }
        
        reform_data(data){
            this.data = data;
            this.member_id = this.data.member_id;
            this.member_name = this.data.member_name != "None" ? this.data.member_name: "미입력" ;
            this.member_user_id = this.data.member_user_id != "None" ? this.data.member_user_id : "미입력";
            this.member_phone = this.data.member_phone != "None" ? this.data.member_phone : "미입력";
            this.member_birth = this.data.member_birthday_dt != "None" ? this.data.member_birthday_d : "미입력";
            this.member_sex = this.data.member_sex != "None" ? this.data.member_sex : "미입력";
            this.member_note = "% 회원 특이사항 특이사항 특이사항";
            this.member_sync = this.data.member_connection_check;

            this.items =    {    
                                member_first_name: {visible: true, title:"회원명", value:this.member_name, input_type:"text"},
                                member_user_id: {visible: true, title:"아이디", value: this.member_user_id, input_type:"disabled"},
                                member_phone: {visible: true, title:"연락처", value: this.member_phone, input_type:"number"},
                                member_birthday: {visible: true, title:"생년월일", value: this.member_birth, input_type:"date"},
                                member_sex: {visible: true, title:"성별", value: this.member_sex, input_type:"option", option_data:
                                   {"남성":{value: 0, callback: ()=>{}}, "여성":{value: 1, callback: ()=>{}}}
                                },
                                member_note: {visible: true, title:"특이사항", value: this.member_note, input_type:"text"},
                                member_ticket_history: {visible: true, title:"수강권 이력", value:"", input_type:"link"},
                                member_lecture_history: {visible: true, title:"수업 이력", value:"", input_type:"link"},
                                member_sync_request: {visible: this.member_sync == 0 ? true : false, title:"연결하기", value:"", input_type:"option", option_data:
                                   {"연결 요청":{value: 0, callback: ()=>{}}}
                                },
                                member_sync_disconnect: {visible: this.member_sync == 1 ? true : false, title:"연결끊기", value:"", input_type:"option", option_data:
                                   {"연결 해제":{value: 0, callback: ()=>{}}}
                                },
                                member_sync_wait: {visible: this.member_sync == 2 ? true : false, title:"연결대기", value:"", input_type:"option", option_data:
                                    {"연결요청 취소":{value: 0, callback: ()=>{}}}
                                },
                                member_deactivate: {visible: true, title:"(임시)회원 비활성화", value:"", input_type:"option", option_data:
                                    {"비활성화":{value: 0, callback: ()=>{this.data_state('member_state_cd', 'PE')}}}
                                },
                                member_activate: {visible: true, title:"(임시)회원 활성화", value:"", input_type:"option", option_data:
                                    {"활성화":{value: 0, callback: ()=>{this.data_state('member_state_cd', 'IP')}}}
                                },
                                member_delete: {visible: true, title:"회원 삭제", value:"", input_type:"option", option_data:
                                    {"완전 삭제":{value: 0, callback: ()=>{this.data_delete();}}}
                                }
                            };
        }


        render_setting_list(target, options){
            if(target == undefined || target == ""){
                target = this.targetHTML;
            }
            if(options != undefined){
                for(let item in options){
                    this.menu_items[item].visible = options[item].visible;
                }
            }

            let html_to_join = [];
            for(let item in this.items){
                let item_el = this.items[item];
                if(item_el.visible == false){
                    continue;
                }
                if(item_el.value == ""){
                    item_el.value = "&nbsp;"
                }

                let if_it_is_delete =false;
                switch(item){
                    //삭제 버튼의 경우 빨간색으로 글자 표기를 위해서
                    case "member_delete":
                        if_it_is_delete = true;
                        break;
                }

                let html = CComponent.setting_row(`${item}`, item_el.title, item_el.value, item_el.input_type, false, if_it_is_delete); 
                html_to_join.push(html);
            }
            document.querySelector(target).innerHTML = `<ul>${html_to_join.join('')}</ul>`; 
            this.attach_events();
        }

        
        attach_events(){
            for(let item in this.items){
                let item_el = this.items[item];
                if(item_el.visible == false){
                    continue;
                }
                
                let onclick;
                let click_type = document.getElementById(`${item}`).dataset.click;
                switch(click_type){
                    case "text":
                        onclick = ()=>{show_user_input_popup(click_type, event.target.innerText, ()=>{member_edit.data_update(event, item)} )};
                        break;
                    case "number":
                        onclick = ()=>{show_user_input_popup(click_type, event.target.innerText, ()=>{member_edit.data_update(event, item)} )};
                        break;
                    case "option":
                        let option_data = item_el.option_data
                        onclick = ()=>{option_select_popup.open(option_data)};
                        break;
                    case "time":
                        // onclick = ()=>{time_select_popup.open(`${this.instance}.data_update(this, '${item}')`)};
                        onclick = ()=>{time_select_popup.open(`${this.instance}.data_update(this, '${item}')`)};
                        break;
                    case "date":
                        // onclick = ()=>{date_select_popup.open(`${this.instance}.data_update(this, '${item}')`)};
                        onclick = ()=>{date_select_popup.open(`${this.instance}.data_update(this, '${item}')`)};
                        break;
                    case "datepicker":
                        onclick = function(event){
                            if($(`#${event.target.id} input`).length == 0){
                                $(`#${event.target.id}`).append('<input type="text" readonly>')
                            }
                            $(`#${event.target.id} input`).datepicker();$(`#${event.target.id} input`).datepicker('show'); }
                        break;
                    case "color":
                        onclick = ()=>{show_user_input_popup(click_type, event.target.innerText, `${this.instance}.data_update(this, '${item}')`)};
                        break;
                    case "disabled":
                        onclick = ()=>{show_error_message("수정 할 수 없는 항목입니다.")}
                        break;
                }
                document.getElementById(`${item}`).onclick = onclick;
            }
        }

        data_update(context, item_name){
            //데이터 형태 {"member_id":"", "first_name":"", "phone":"", "sex":"", "birthday":"", "phone":""};
            let user_input = $(context.target).parent().siblings('div').find('.popup_basic_user_input_data').val();
            let data_to_send = {};
            data_to_send["member_id"] = this.member_id;
            data_to_send[item_name.replace(/member_/gi,"")] = user_input;
            
            Member_func.update(data_to_send, () => {
                this.data_refresh();
            }) 
        }

        data_state(item_name, external_input){
            let data_to_send = {};
            data_to_send["member_id"] = this.member_id;
            data_to_send[item_name.replace(/member_/gi,"")] = external_input;
            
            Member_func.status(data_to_send, () => {
                this.data_refresh();
            }) 
        }

        data_delete(){
            let data_to_send = {};
            data_to_send["member_id"] = this.member_id;
            
            Member_func.delete(data_to_send, () => {
                // this.data_refresh();
                layer_popup.all_close_layer_popup();
                member.init();
            }) 
        }

        data_refresh(){
            Member_func.read({"member_id":this.member_id}, (data)=>{
                this.reform_data(data);
                this.render_setting_list();
                member_info_popup.refresh(data);
                member.init();
            })
        }
    }

    var member_edit = new Member_edit("#wrapper_box_member_settings", member_info, "member_edit");
    member_edit.init();

    func_set_webkit_overflow_scrolling('.popup_ticket_view');
</script>
{% endblock %}
