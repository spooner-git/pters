{% extends "trainer_base.html" %}
{% load static_url %}

{% block local_css %}
    <link rel="stylesheet" href={% static_url "user/css/trainer/pters.trainer.payment.css" %}>
    <link rel="stylesheet" href={% static_url "user/css/pters.add.style.css" %}>
{% endblock %}

{% block content %}

    <div id="ymdText">
        <!--
    <div class='arrowButton'>
     <a style="left: 6%;cursor: pointer;"><img src={% static_url "user/res/daycal_arrow.png" %} alt="" style="width: 7px;"></a>
     <a style="right: 6%;cursor: pointer;"><img src={% static_url "user/res/daycal_arrow.png" %} alt="" style="-webkit-transform:rotate(180deg);width: 7px;"></a>
    </div>
  -->
        <div id="ymdTextWrap">
            <div id="menuName">이용권 구매
            </div>
            <div id="menuDescription">나에게 꼭 맞는 추가기능 이용권을 선택하세요!
            </div>
        </div>
    </div>


    <div id="payment_contents_wrap">
        <div class="payment_function_wrap">
            <label class="function_label">그룹 레슨</label>
            <p>그룹 관리 메뉴 사용 + 그룹 일정 관리 + 강사 및 소속 회원의 화면에서 광고 제거</p>
            <div class="payment_monthly">
                <label class="inner_label">정기 결제</label>
                <p class="inner_explain"><span style="color:#9c9c9c;font-size: 16px;text-decoration: line-through;">12,000원</span><span style="font-weight:bold;font-size: 16px;color:#fe4e65;"> → 매월 9,000원</span></p>
                <button id="pay_group_function_monthly">정기 결제 구매</button>
            </div>
            <div class="seperator"></div>
            <div class="payment_instant">
                <label class="inner_label">1개월 이용권</label>
                <p class="inner_explain"><span style="font-weight:500;font-size: 14px;color:#5f5f5f;">1회 1개월 이용  12,000원</span></p>
                <button id="pay_group_function_instant">구매</button>
            </div>
        </div>

        <div class="payment_function_wrap">
            <label class="function_label">광고 제거</label>
            <p>강사 및 소속 회원의 화면에서 광고 제거</p>
            <div class="payment_monthly">
                <label class="inner_label">정기 결제</label>
                <p class="inner_explain"><span style="color:#9c9c9c;font-size: 16px;text-decoration: line-through;">2,000원</span><span style="font-weight:bold;font-size: 16px;color:#fe4e65;"> → 매월 1,000원</span></p>
                <button id="pay_ads_remove_monthly">정기 결제 구매</button>
            </div>
            <div class="seperator"></div>
            <div class="payment_instant">
                <label class="inner_label">1개월 이용권</label>
                <p class="inner_explain"><span style="font-weight:500;font-size: 14px;color:#5f5f5f;">1회 1개월 이용  2,000원</span></p>
                <button id="pay_ads_remove_instant">구매</button>
            </div>
        </div>
    </div>


    <!--
    <div class="popupBtn_mini">
        <button class="submitBtn _button_Prev">이전</button>
        <button class="submitBtn _button_Next" style="display: none;">등록</button>
    </div>
-->

    <form id="modify-member-id-form" method="post">
        {% csrf_token %}
        <div style="display: none">
            {{ form.as_p }}
        </div>
        <input type="hidden" name="member_id" id="userDbId" value="">

    </form>

{% endblock %}

{% block local_js_footer %}

    <script type="text/javascript" src="https://service.iamport.kr/js/iamport.payment-1.1.5.js"></script>
    <!-- for db by hk.kim 170805-->
    <script>
        var krHolidayList =  [{% for holiday_day in holiday %}'{{ holiday_day.holiday_dt }}'{%if forloop.last == False%},{% endif %}{% endfor %}];//대한민국 공휴일 (구정, 추석 제외)

        var offRepeatScheduleIdArray =  [{% for off_repeat_schedule_id_info in off_repeat_schedule_id_data %}'{{ off_repeat_schedule_id_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
        var offRepeatScheduleTypeArray =  [{% for off_repeat_schedule_type_info in off_repeat_schedule_type_data %}'{{ off_repeat_schedule_type_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
        var offRepeatScheduleWeekInfoArray =  [{% for off_repeat_schedule_week_info_info in off_repeat_schedule_week_info_data %}'{{ off_repeat_schedule_week_info_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
        var offRepeatScheduleStartDateArray =  [{% for off_repeat_schedule_start_date_info in off_repeat_schedule_start_date_data %}'{{ off_repeat_schedule_start_date_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
        var offRepeatScheduleEndDateArray =  [{% for off_repeat_schedule_end_date_info in off_repeat_schedule_end_date_data %}'{{ off_repeat_schedule_end_date_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
        var offRepeatScheduleStartTimeArray =  [{% for off_repeat_schedule_start_time_info in off_repeat_schedule_start_time_data %}'{{ off_repeat_schedule_start_time_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
        var offRepeatScheduleTimeDurationArray =  [{% for off_repeat_schedule_time_duration_info in off_repeat_schedule_time_duration_data %}'{{ off_repeat_schedule_time_duration_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
    </script>

    <!-- Placed at the end of the document so the pages load faster -->

    <script>

        if($('body').width()<600){
            $('#page-base').css('display','block')
            //$('#page-base-modifystyle').css('display','block')
            $('#uptext3').text('이용권 구매')
            $('#uptext').text("이용권 구매")
            $('#upbutton-modify').hide()
        }


        $('#upbutton-x-modify, ._button_Prev').click(function(){
            location.href="/trainer/trainer_setting/"
        });


        $('#pay_group_function_monthly').click(function(e){
{#            alert('그룹 정기 결제');#}
            e.preventDefault();
            payment();
            //그룹 레슨 정기결제 버튼
        })
        $('#pay_group_function_instant').click(function(e){
{#            alert('그룹 1개월 이용권 결제');#}
            e.preventDefault();
            payment();
            //그룹 레슨 1개월 결제 버튼
        })
        $('#pay_ads_remove_monthly').click(function(e){
{#            alert('광고 제거 정기 결제');#}
            e.preventDefault();
            payment();
            //광고 제거 정기 결제 버튼
        })
        $('#pay_ads_remove_instant').click(function(e){
{#            alert('광고 제거 1개월 결제');#}
            e.preventDefault();
            payment();
            //광고 제거 1개월 결제 버튼
        })

        /*
        function goPage(option){
            if(option == 2){
                location.href= "/accounts/password/change/"
            }else if(option = "delAccount"){
                location.href="/trainer/delete_account/";
            }
        }
        */

        var IMP = window.IMP; // 생략가능
        IMP.init('{{ payment_id }}'); // 'iamport' 대신 부여받은 "가맹점 식별코드"를 사용

        function payment(){
            console.log('payment function test');
            var merchant_uid_data = 'pters_group_merchant_'+ new Date().getTime();
            var customer_uid_data = 'pters_group_customer_'+ new Date().getTime();
            jQuery.ajax({
                url: "/payment/add_billing/", // 서비스 웹서버
                method: "POST",
                headers: { "Content-Type": "application/json" },
                data: JSON.stringify({
                    start_date: '2018-06-26',
                    end_date: '2018-07-26',
                    payment_type_cd: 'PERIOD',
                    merchandise_type_cd: 'group',
                    merchant_uid: merchant_uid_data,
                    price : 3000,
                    customer_uid: customer_uid_data,
{#                            customer_uid: 'pters_customer_uid_{{request.user.id}}_033' // 카드(빌링키)와 1:1로 대응하는 값#}
                })
            })
            IMP.request_pay({
                pg : 'jtnet', // version 1.1.0부터 지원.
                pay_method : 'card',
                merchant_uid : merchant_uid_data,
                customer_uid : customer_uid_data, // 카드(빌링키)와 1:1로 대응하는 값
                name : 'PTERS 그룹 기능',
                amount : 3300,
                buyer_email : '{{ request.user.email }}',
                buyer_name : '{{ request.user.last_name }} {{ request.user.first_name }}',
                buyer_tel : '',
                buyer_addr : '서울특별시 강남구 삼성동',
                buyer_postcode : '123-456',
                m_redirect_url : '/payment/add_billing/'
            }, function(rsp) {
                var msg;
                if ( rsp.success ) {
                    console.log(rsp);
                    msg = '결제가 완료되었습니다.';
                    msg += '고유ID : ' + rsp.imp_uid;
                    msg += '상점 거래ID : ' + rsp.merchant_uid;
                    msg += '결제 금액 : ' + rsp.paid_amount;
                    msg += '카드 승인번호 : ' + rsp.apply_num;
{#                    jQuery.ajax({#}
{#                        url: "/payment/billings/", // 서비스 웹서버#}
{#                        method: "POST",#}
{#                        headers: { "Content-Type": "application/json" },#}
{#                        data: JSON.stringify({#}
{#                            start_date: '2018-06-26',#}
{#                            end_date: '2018-07-26',#}
{#                            payment_type_cd: 'PERIOD',#}
{#                            merchandise_type_cd: 'group',#}
{#                            merchant_uid: rsp.merchant_uid,#}
{#                            price : 3000,#}
{#                            customer_uid: 'pters_customer_uid_{{request.user.id}}_033',#}
{#                            customer_uid: 'pters_customer_uid_{{request.user.id}}_033' // 카드(빌링키)와 1:1로 대응하는 값#}
{#                        })#}
{#                    })#}
                } else {
                    msg = '결제에 실패하였습니다.';
                    msg += '에러내용 : ' + rsp.error_msg;
                    jQuery.ajax({
                        url: "/payment/delete_billing/", // 서비스 웹서버
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        data: JSON.stringify({
                            merchant_uid: merchant_uid_data,
                            customer_uid: customer_uid_data
                        })
                    })
                }
                alert(msg);
            });
        }
    </script>

{% endblock %}

