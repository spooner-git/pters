{% extends "trainer_base.html" %}
{% load static_url %}

{% block local_css %}
    <link rel="stylesheet" href={% static_url "user/css/trainer/pters.trainer.payment.css" %}>
    <link rel="stylesheet" href={% static_url "user/css/pters.add.style.css" %}>
{% endblock %}

{% block content %}

    <div id="ymdText">
        <!--
    <div class='arrowButton'>
     <a style="left: 6%;cursor: pointer;"><img src={% static_url "user/res/daycal_arrow.png" %} alt="" style="width: 7px;"></a>
     <a style="right: 6%;cursor: pointer;"><img src={% static_url "user/res/daycal_arrow.png" %} alt="" style="-webkit-transform:rotate(180deg);width: 7px;"></a>
    </div>
  -->
        <div id="ymdTextWrap">
            <div id="menuName">이용권 구매
            </div>
            <div id="menuDescription">나에게 꼭 맞는 추가기능 이용권을 선택하세요!
            </div>
        </div>
    </div>


    <div id="payment_contents_wrap">
        <div class="payment_function_wrap">
            <label class="function_label">그룹 레슨</label>
            <p>그룹 관리 메뉴 사용 + 그룹 일정 관리 + 강사 및 소속 회원의 화면에서 광고 제거</p>
            <div class="payment_monthly">
                <label class="inner_label">정기 결제</label>
                <p class="inner_explain"><span style="color:#9c9c9c;font-size: 16px;text-decoration: line-through;">12,000원</span><span style="font-weight:bold;font-size: 16px;color:#fe4e65;"> → 매월 9,000원</span></p>
                <button id="pay_group_function_monthly">정기 결제 구매</button>
            </div>
            <div class="seperator"></div>
            <div class="payment_instant">
                <label class="inner_label">1개월 이용권</label>
                <p class="inner_explain"><span style="font-weight:500;font-size: 14px;color:#5f5f5f;">1회 1개월 이용  12,000원</span></p>
                <button id="pay_group_function_instant">구매</button>
            </div>
        </div>

        <div class="payment_function_wrap">
            <label class="function_label">광고 제거</label>
            <p>강사 및 소속 회원의 화면에서 광고 제거</p>
            <div class="payment_monthly">
                <label class="inner_label">정기 결제</label>
                <p class="inner_explain"><span style="color:#9c9c9c;font-size: 16px;text-decoration: line-through;">2,000원</span><span style="font-weight:bold;font-size: 16px;color:#fe4e65;"> → 매월 1,000원</span></p>
                <button id="pay_ads_remove_monthly">정기 결제 구매</button>
            </div>
            <div class="seperator"></div>
            <div class="payment_instant">
                <label class="inner_label">1개월 이용권</label>
                <p class="inner_explain"><span style="font-weight:500;font-size: 14px;color:#5f5f5f;">1회 1개월 이용  2,000원</span></p>
                <button id="pay_ads_remove_instant">구매</button>
            </div>
        </div>
    </div>


    <!--
    <div class="popupBtn_mini">
        <button class="submitBtn _button_Prev">이전</button>
        <button class="submitBtn _button_Next" style="display: none;">등록</button>
    </div>
-->

    <form id="modify-member-id-form" method="post">
        {% csrf_token %}
        <div style="display: none">
            {{ form.as_p }}
        </div>
        <input type="hidden" name="member_id" id="userDbId" value="">

    </form>

{% endblock %}

{% block local_js_footer %}

    <script type="text/javascript" src="https://service.iamport.kr/js/iamport.payment-1.1.5.js"></script>
    <!-- for db by hk.kim 170805-->
    <script>
        var krHolidayList =  [{% for holiday_day in holiday %}'{{ holiday_day.holiday_dt }}'{%if forloop.last == False%},{% endif %}{% endfor %}];//대한민국 공휴일 (구정, 추석 제외)

        var offRepeatScheduleIdArray =  [{% for off_repeat_schedule_id_info in off_repeat_schedule_id_data %}'{{ off_repeat_schedule_id_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
        var offRepeatScheduleTypeArray =  [{% for off_repeat_schedule_type_info in off_repeat_schedule_type_data %}'{{ off_repeat_schedule_type_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
        var offRepeatScheduleWeekInfoArray =  [{% for off_repeat_schedule_week_info_info in off_repeat_schedule_week_info_data %}'{{ off_repeat_schedule_week_info_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
        var offRepeatScheduleStartDateArray =  [{% for off_repeat_schedule_start_date_info in off_repeat_schedule_start_date_data %}'{{ off_repeat_schedule_start_date_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
        var offRepeatScheduleEndDateArray =  [{% for off_repeat_schedule_end_date_info in off_repeat_schedule_end_date_data %}'{{ off_repeat_schedule_end_date_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
        var offRepeatScheduleStartTimeArray =  [{% for off_repeat_schedule_start_time_info in off_repeat_schedule_start_time_data %}'{{ off_repeat_schedule_start_time_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
        var offRepeatScheduleTimeDurationArray =  [{% for off_repeat_schedule_time_duration_info in off_repeat_schedule_time_duration_data %}'{{ off_repeat_schedule_time_duration_info }}'{%if forloop.last == False%},{% endif %}{% endfor %}];
    </script>

    <!-- Placed at the end of the document so the pages load faster -->

    <script>

        if($('body').width()<600){
            $('#page-base').css('display','block')
            //$('#page-base-modifystyle').css('display','block')
            $('#uptext3').text('이용권 구매')
            $('#uptext').text("이용권 구매")
            $('#upbutton-modify').hide()
        }


        $('#upbutton-x-modify, ._button_Prev').click(function(){
            location.href="/trainer/trainer_setting/"
        });

        $('#pay_group_function_monthly').click(function(e){
{#            alert('그룹 정기 결제');#}
            e.preventDefault();
            payment('PTERS - 그룹기능 정기 결제', 'card', 'PERIOD', 'GROUP', 9000);
            //그룹 레슨 정기결제 버튼
        });
        $('#pay_group_function_instant').click(function(e){
{#            alert('그룹 1개월 이용권 결제');#}
            e.preventDefault();
            payment('PTERS - 그룹기능 1개월 이용권', 'card', 'SINGLE', 'GROUP', 12000);
            //그룹 레슨 1개월 결제 버튼
        });
        $('#pay_ads_remove_monthly').click(function(e){
{#            alert('광고 제거 정기 결제');#}
            e.preventDefault();
            payment('PTERS - 광고제거 정기 결제', 'card', 'PERIOD', 'ADVERTISE', 1000);
            //광고 제거 정기 결제 버튼
        });
        $('#pay_ads_remove_instant').click(function(e){
{#            alert('광고 제거 1개월 결제');#}
            e.preventDefault();
            payment('PTERS - 광고제거 1개월 이용권', 'card', 'SINGLE', 'ADVERTISE', 2000);
            //광고 제거 1개월 결제 버튼
        });

        /*
        function goPage(option){
            if(option == 2){
                location.href= "/accounts/password/change/"
            }else if(option = "delAccount"){
                location.href="/trainer/delete_account/";
            }
        }
        */
        function check_payment(payment_type_cd, merchandise_type_cd, price){
            var error_check = true;

            $.ajax({
                url: "/payment/check_billing/", // 서비스 웹서버
                method: "POST",
                headers: { "Content-Type": "application/json" },
                data: JSON.stringify({
                    start_date:  today,
                    payment_type_cd: payment_type_cd,
                    merchandise_type_cd: merchandise_type_cd,
                    price : price
                }),

                beforeSend:function(){
                    beforeSend();
                },

                success:function(data){
                    var jsondata = JSON.parse(data);
                    initialJSON = jsondata;
                    console.log(initialJSON);
                    if(jsondata.messageArray.length>0){
                        $('#errorMessageBar').show();
                        $('#errorMessageText').text(jsondata.messageArray);
                        error_check = false;
                    }else {
                        if(payment_type_cd=='PERIOD'){
                            payment_open_pg(name, pay_method, merchant_uid_data, customer_uid_data, price);
                        }
                        else{
                            payment_open_pg_single(name, pay_method, merchant_uid_data, price);
                        }
                    }

                },

                complete:function(){
                    completeSend();
                },

                error:function(){
                    console.log('server error');
                }
            });


            return error_check;
        }

        var IMP = window.IMP; // 생략가능
        IMP.init('{{ payment_id }}'); // 'iamport' 대신 부여받은 "가맹점 식별코드"를 사용

        function payment(name, pay_method, payment_type_cd, merchandise_type_cd, price){
            var success = false;
            var date = new Date();
            var merchant_uid_data = 'merchant_{{request.user.id}}_'+merchandise_type_cd+'_' + date.getTime();
            var customer_uid_data = 'customer_{{request.user.id}}_'+merchandise_type_cd+'_' + date.getTime();
            var today = date.getFullYear()+'-'+(date.getMonth()+1)+'-'+date.getDate();

            $.ajax({
                url: "/payment/add_billing/", // 서비스 웹서버
                method: "POST",
                headers: { "Content-Type": "application/json" },
                data: JSON.stringify({
                    start_date:  today,
                    pay_method: pay_method,
                    payment_type_cd: payment_type_cd,
                    merchandise_type_cd: merchandise_type_cd,
                    merchant_uid: merchant_uid_data,
                    customer_uid: customer_uid_data,
                    price : price,
                    name : name
                }),

                beforeSend:function(){
                    beforeSend();
                },

                success:function(data){
                    var jsondata = JSON.parse(data);
                    initialJSON = jsondata;
                    console.log(initialJSON);
                    if(jsondata.messageArray.length>0){
                        $('#errorMessageBar').show();
                        $('#errorMessageText').text(jsondata.messageArray);
                    }else {
                        success = true;
                        if(payment_type_cd=='PERIOD'){
                            payment_open_pg(name, pay_method, merchant_uid_data, customer_uid_data, payment_type_cd, price);
                        }
                        else{
                            payment_open_pg_single(name, pay_method, merchant_uid_data, payment_type_cd, price);
                        }
                    }

                },

                complete:function(){
                    completeSend();
                },

                error:function(){
                    console.log('server error');
                }
            });

            if ( success == true){
                console.log('success');

            }
        }

        function payment_open_pg(name, pay_method, merchant_uid_data, customer_uid_data, payment_type_cd, price) {
            console.log('payment_open_pg');
                var custom_data = {
                    "user_id":{{ request.user.id }},
                    "payment_type_cd":payment_type_cd,
                    "customer_uid":customer_uid_data
                };
                IMP.request_pay({
                    pg : 'danal', // version 1.1.0부터 지원.
                    pay_method : pay_method,
                    merchant_uid : merchant_uid_data,
                    customer_uid : customer_uid_data, // 카드(빌링키)와 1:1로 대응하는 값
                    name : name,
                    amount : price,
                    custom_data: custom_data,
{#                    custom_data: {user_id: {{ request.user.id }}, payment_type_cd: payment_type_cd, customer_uid: customer_uid_data},#}
                    buyer_email : '{{ request.user.email }}',
                    buyer_name : '{{ request.user.last_name }} {{ request.user.first_name }}',
{#                    buyer_tel : '',#}
{#                    buyer_addr : '서울특별시 강남구 삼성동',#}
{#                    buyer_postcode : '123-456',#}
{#                    m_redirect_url : '/payment/add_billing/'#}
                }, function(rsp) {
                    var msg;
                    if ( rsp.success ) {
                        console.log(rsp);

                        $.ajax({
                            url: "/payment/billing_finish/", // 서비스 웹서버
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            data: JSON.stringify({
                                merchant_uid: rsp.merchant_uid,
                                customer_uid: customer_uid_data,
                                paid_amount: rsp.paid_amount
                            }),

                            beforeSend:function(){
                                beforeSend();
                            },

                            success:function(data){
                                var jsondata = JSON.parse(data);
                                initialJSON = jsondata;
                                console.log('/payment/billing_finish/::'+jsondata);
                                if(jsondata.messageArray.length>0){
                                    msg = '결제에 실패하였습니다.';
                                    msg += '에러내용 : ' + jsondata.messageArray;
                                }else {
                                    msg = '결제가 완료되었습니다.';
            {#                        msg += '고유ID : ' + rsp.imp_uid;#}
            {#                        msg += '상점 거래ID : ' + rsp.merchant_uid;#}
                                    msg += '결제 금액 : ' + rsp.paid_amount;
            {#                        msg += '카드 승인번호 : ' + rsp.apply_num;#}
                                }
                                alert(msg);

                            },

                            complete:function(){
                                completeSend();
                            },

                            error:function(){
                                console.log('server error');
                            }
                        });

                    } else {
                        msg = '결제에 실패하였습니다.';
                        msg += '에러내용 : ' + rsp.error_msg;
                        jQuery.ajax({
                            url: "/payment/delete_billing/", // 서비스 웹서버
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            data: JSON.stringify({
                                merchant_uid: merchant_uid_data,
                                customer_uid: customer_uid_data
                            })
                        });
                        alert(msg);
                    }
                });
        }

        function payment_open_pg_single(name, pay_method, merchant_uid_data, payment_type_cd, price) {

                var custom_data = {
                    "user_id":{{ request.user.id }},
                    "payment_type_cd":payment_type_cd
                };
                IMP.request_pay({
                    pg : 'danal', // version 1.1.0부터 지원.
                    pay_method : pay_method,
                    merchant_uid : merchant_uid_data,
                    name : name,
                    amount : price,
                    custom_data: custom_data,
                    buyer_email : '{{ request.user.email }}',
                    buyer_name : '{{ request.user.last_name }} {{ request.user.first_name }}',
{#                    buyer_tel : '',#}
{#                    buyer_addr : '서울특별시 강남구 삼성동',#}
{#                    buyer_postcode : '123-456',#}
{#                    m_redirect_url : '/payment/add_billing/'#}
                }, function(rsp) {
                    var msg;
                    if ( rsp.success ) {
                        console.log(rsp);

                        $.ajax({
                            url: "/payment/billing_finish/", // 서비스 웹서버
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            data: JSON.stringify({
                                merchant_uid: rsp.merchant_uid,
                                paid_amount: rsp.paid_amount
                            }),

                            beforeSend:function(){
                                beforeSend();
                            },

                            success:function(data){
                                var jsondata = JSON.parse(data);
                                initialJSON = jsondata;
                                console.log('/payment/billing_finish/::'+jsondata);
                                if(jsondata.messageArray.length>0){
                                    msg = '결제에 실패하였습니다.';
                                    msg += '에러내용 : ' + jsondata.messageArray;
                                }else {
                                    msg = '결제가 완료되었습니다.';
            {#                        msg += '고유ID : ' + rsp.imp_uid;#}
            {#                        msg += '상점 거래ID : ' + rsp.merchant_uid;#}
                                    msg += '결제 금액 : ' + rsp.paid_amount;
            {#                        msg += '카드 승인번호 : ' + rsp.apply_num;#}
                                }
                                alert(msg);

                            },

                            complete:function(){
                                completeSend();
                            },

                            error:function(){
                                console.log('server error');
                            }
                        });

                    } else {
                        msg = '결제에 실패하였습니다.';
                        msg += '에러내용 : ' + rsp.error_msg;
                        jQuery.ajax({
                            url: "/payment/delete_billing/", // 서비스 웹서버
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            data: JSON.stringify({
                                merchant_uid: merchant_uid_data
                            })
                        });
                        alert(msg);
                    }
                });
        }
    </script>

{% endblock %}

